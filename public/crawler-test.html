<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å°çº¢ä¹¦çˆ¬è™«åŠŸèƒ½æµ‹è¯•</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'xiaohongshu': '#fe2c55',
                        'success': '#10b981',
                        'warning': '#f59e0b',
                        'error': '#ef4444'
                    }
                }
            }
        }
    </script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- å¯¼èˆªæ  -->
    <nav class="bg-white shadow-lg border-b border-gray-200">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16">
                <div class="flex items-center">
                    <i class="fas fa-spider text-xiaohongshu text-2xl mr-3"></i>
                    <h1 class="text-xl font-bold text-gray-900">å°çº¢ä¹¦çˆ¬è™«åŠŸèƒ½æµ‹è¯•</h1>
                </div>
                <div class="flex items-center space-x-4">
                    <a href="/" class="text-gray-600 hover:text-xiaohongshu transition-colors">
                        <i class="fas fa-home mr-1"></i>è¿”å›ä¸»é¡µ
                    </a>
                </div>
            </div>
        </div>
    </nav>

    <div class="max-w-6xl mx-auto px-4 py-8">
        <!-- çŠ¶æ€æ¨ªå¹… -->
        <div id="status-banner" class="mb-6 p-4 rounded-lg border">
            <div class="flex items-center">
                <div class="flex-shrink-0">
                    <span id="status-icon" class="text-2xl">ğŸ”„</span>
                </div>
                <div class="ml-3">
                    <h3 id="status-title" class="text-lg font-medium">æ£€æŸ¥çˆ¬è™«çŠ¶æ€ä¸­...</h3>
                    <p id="status-description" class="text-sm">æ­£åœ¨éªŒè¯çˆ¬è™«æ¨¡å¼å’ŒæœåŠ¡çŠ¶æ€</p>
                </div>
            </div>
        </div>

        <!-- ç™»å½•çŠ¶æ€æ¨ªå¹… -->
        <div id="login-banner" class="mb-6 p-4 bg-yellow-50 border border-yellow-200 rounded-lg">
            <div class="flex items-center justify-between">
                <div class="flex items-center">
                    <span id="login-status-icon" class="mr-3 text-xl">âš ï¸</span>
                    <div>
                        <h3 id="login-status-title" class="text-sm font-medium text-yellow-800">æœªç™»å½•å°çº¢ä¹¦è´¦æˆ·</h3>
                        <p id="login-status-desc" class="text-xs text-yellow-600">å¯èƒ½é‡åˆ°åçˆ¬è™«é™åˆ¶ï¼Œå»ºè®®ç™»å½•ä»¥è·å–çœŸå®æ•°æ®</p>
                    </div>
                </div>
                <div class="flex space-x-2">
                    <button id="get-cookies-btn" class="px-3 py-1 bg-purple-600 text-white text-xs rounded hover:bg-purple-700 transition-colors">
                        <i class="fas fa-cookie-bite mr-1"></i>è·å–Cookies
                    </button>
                    <button id="quick-login-btn" class="px-3 py-1 bg-green-600 text-white text-xs rounded hover:bg-green-700 transition-colors">
                        <i class="fas fa-bolt mr-1"></i>å¿«é€Ÿç¡®è®¤
                    </button>
                    <button id="login-btn" class="px-4 py-2 bg-blue-600 text-white text-sm rounded hover:bg-blue-700 transition-colors">
                        <i class="fas fa-sign-in-alt mr-1"></i>ç™»å½•éªŒè¯
                    </button>
                </div>
            </div>
        </div>

        <!-- æµ‹è¯•åŒºåŸŸ -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <!-- å·¦ä¾§ï¼šè¾“å…¥å’Œæ§åˆ¶ -->
            <div class="space-y-6">
                <!-- URLè¾“å…¥ -->
                <div class="bg-white rounded-lg shadow-md p-6">
                    <h2 class="text-lg font-semibold text-gray-900 mb-4">
                        <i class="fas fa-link text-xiaohongshu mr-2"></i>
                        å°çº¢ä¹¦é“¾æ¥æµ‹è¯•
                    </h2>
                    
                    <!-- é¢„è®¾é“¾æ¥ -->
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">å¿«é€Ÿæµ‹è¯•é“¾æ¥</label>
                        <div class="space-y-2">
                            <button class="preset-url w-full text-left p-2 border border-gray-300 rounded hover:bg-gray-50 text-sm" 
                                    data-url="https://www.xiaohongshu.com/explore/673a5c2e000000001203e435">
                                ğŸ“ æµ‹è¯•ç¬”è®°1 (å¯èƒ½é‡åˆ°é™åˆ¶)
                            </button>
                            <button class="preset-url w-full text-left p-2 border border-gray-300 rounded hover:bg-gray-50 text-sm"
                                    data-url="https://www.xiaohongshu.com/user/profile/60899013000000000100439d">
                                ğŸ‘¤ æµ‹è¯•ç”¨æˆ·ä¸»é¡µ
                            </button>
                        </div>
                    </div>

                    <!-- è‡ªå®šä¹‰è¾“å…¥ -->
                    <div class="mb-4">
                        <label for="test-url" class="block text-sm font-medium text-gray-700 mb-2">
                            æˆ–è¾“å…¥è‡ªå®šä¹‰é“¾æ¥
                        </label>
                        <input type="url" id="test-url" 
                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-xiaohongshu focus:border-xiaohongshu"
                               placeholder="https://www.xiaohongshu.com/explore/...">
                    </div>

                    <!-- çˆ¬å–é€‰é¡¹ -->
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">çˆ¬å–é€‰é¡¹</label>
                        <div class="flex items-center space-x-4">
                            <label class="flex items-center">
                                <input type="radio" name="crawl-type" value="auto" checked class="mr-2">
                                <span class="text-sm">è‡ªåŠ¨è¯†åˆ«</span>
                            </label>
                            <label class="flex items-center">
                                <input type="radio" name="crawl-type" value="note" class="mr-2">
                                <span class="text-sm">å•ä¸ªç¬”è®°</span>
                            </label>
                            <label class="flex items-center">
                                <input type="radio" name="crawl-type" value="user" class="mr-2">
                                <span class="text-sm">ç”¨æˆ·ä¸»é¡µ</span>
                            </label>
                        </div>
                    </div>

                    <!-- ç”¨æˆ·ä¸»é¡µé™åˆ¶ -->
                    <div id="user-limit-section" class="mb-4 hidden">
                        <label for="user-limit" class="block text-sm font-medium text-gray-700 mb-2">
                            è·å–ç¬”è®°æ•°é‡
                        </label>
                        <select id="user-limit" class="w-full px-3 py-2 border border-gray-300 rounded-md">
                            <option value="3">3ç¯‡ (æ¨è)</option>
                            <option value="5">5ç¯‡</option>
                            <option value="10">10ç¯‡</option>
                        </select>
                    </div>

                    <!-- æµ‹è¯•æŒ‰é’® -->
                    <button id="start-test" class="w-full bg-xiaohongshu text-white py-2 px-4 rounded-md hover:bg-red-600 transition-colors font-medium">
                        <i class="fas fa-play mr-2"></i>
                        å¼€å§‹çˆ¬å–æµ‹è¯•
                    </button>
                </div>

                <!-- å®æ—¶æ—¥å¿— -->
                <div class="bg-white rounded-lg shadow-md p-6">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">
                        <i class="fas fa-terminal text-gray-600 mr-2"></i>
                        å®æ—¶æ—¥å¿—
                    </h3>
                    <div id="log-container" class="bg-gray-900 text-green-400 p-4 rounded-md h-40 overflow-y-auto font-mono text-sm">
                        <div class="log-entry">[ç³»ç»Ÿ] çˆ¬è™«æµ‹è¯•å™¨å·²å‡†å¤‡å°±ç»ª</div>
                    </div>
                    <button id="clear-log" class="mt-2 text-sm text-gray-600 hover:text-gray-800">
                        <i class="fas fa-trash mr-1"></i>æ¸…ç©ºæ—¥å¿—
                    </button>
                </div>
            </div>

            <!-- å³ä¾§ï¼šç»“æœæ˜¾ç¤º -->
            <div class="space-y-6">
                <!-- çˆ¬å–ç»“æœ -->
                <div class="bg-white rounded-lg shadow-md p-6">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">
                        <i class="fas fa-database text-blue-600 mr-2"></i>
                        çˆ¬å–ç»“æœ
                    </h3>
                    
                    <div id="result-container" class="space-y-4">
                        <div class="text-center text-gray-500 py-8">
                            <i class="fas fa-search text-4xl mb-4"></i>
                            <p>è¯·å¼€å§‹çˆ¬å–æµ‹è¯•ä»¥æŸ¥çœ‹ç»“æœ</p>
                        </div>
                    </div>
                </div>

                <!-- æŠ€æœ¯åˆ†æ -->
                <div class="bg-white rounded-lg shadow-md p-6">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">
                        <i class="fas fa-cogs text-purple-600 mr-2"></i>
                        æŠ€æœ¯åˆ†æ
                    </h3>
                    
                    <div id="tech-analysis" class="space-y-3">
                        <div class="text-center text-gray-500 py-4">
                            <i class="fas fa-chart-line text-3xl mb-3"></i>
                            <p>çˆ¬å–å®Œæˆåå°†æ˜¾ç¤ºæŠ€æœ¯åˆ†æ</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- å¸®åŠ©ä¿¡æ¯ -->
        <div class="mt-8 bg-blue-50 border border-blue-200 rounded-lg p-6">
            <h3 class="text-lg font-semibold text-blue-900 mb-3">
                <i class="fas fa-info-circle mr-2"></i>
                ä½¿ç”¨è¯´æ˜
            </h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm text-blue-800">
                <div>
                    <h4 class="font-medium mb-2">ğŸ¯ æµ‹è¯•ç›®çš„</h4>
                    <ul class="space-y-1">
                        <li>â€¢ éªŒè¯çœŸå®çˆ¬è™«åŠŸèƒ½</li>
                        <li>â€¢ æ£€æµ‹åçˆ¬è™«é™åˆ¶</li>
                        <li>â€¢ åˆ†ææ•°æ®è·å–è´¨é‡</li>
                        <li>â€¢ ç›‘æ§çˆ¬å–æ€§èƒ½</li>
                    </ul>
                </div>
                <div>
                    <h4 class="font-medium mb-2">ğŸ“ æµ‹è¯•å»ºè®®</h4>
                    <ul class="space-y-1">
                        <li>â€¢ ä¼˜å…ˆæµ‹è¯•ç”¨æˆ·ä¸»é¡µé“¾æ¥</li>
                        <li>â€¢ å•ä¸ªç¬”è®°å¯èƒ½é‡åˆ°é™åˆ¶</li>
                        <li>â€¢ è§‚å¯Ÿå®æ—¶æ—¥å¿—äº†è§£è¿‡ç¨‹</li>
                        <li>â€¢ æ£€æŸ¥æŠ€æœ¯åˆ†æåˆ¤æ–­æ•°æ®è´¨é‡</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentTest = null;

        $(document).ready(function() {
            // æ£€æŸ¥çˆ¬è™«çŠ¶æ€
            checkCrawlerStatus();
            
            // ç»‘å®šäº‹ä»¶
            bindEvents();
        });

        function bindEvents() {
            // é¢„è®¾é“¾æ¥ç‚¹å‡»
            $('.preset-url').click(function() {
                const url = $(this).data('url');
                $('#test-url').val(url);
                
                // è‡ªåŠ¨è¯†åˆ«ç±»å‹
                if (url.includes('/user/profile/')) {
                    $('input[name="crawl-type"][value="user"]').prop('checked', true);
                    $('#user-limit-section').removeClass('hidden');
                } else {
                    $('input[name="crawl-type"][value="note"]').prop('checked', true);
                    $('#user-limit-section').addClass('hidden');
                }
            });

            // çˆ¬å–ç±»å‹å˜åŒ–
            $('input[name="crawl-type"]').change(function() {
                if ($(this).val() === 'user') {
                    $('#user-limit-section').removeClass('hidden');
                } else {
                    $('#user-limit-section').addClass('hidden');
                }
            });

            // å¼€å§‹æµ‹è¯•
            $('#start-test').click(startCrawlTest);

            // æ¸…ç©ºæ—¥å¿—
            $('#clear-log').click(function() {
                $('#log-container').empty();
                addLog('[ç³»ç»Ÿ] æ—¥å¿—å·²æ¸…ç©º');
            });
        }

        async function checkCrawlerStatus() {
            try {
                const response = await fetch('/api/crawler-mode');
                const data = await response.json();
                
                if (data.success) {
                    updateStatusBanner(data.mode);
                } else {
                    updateStatusBanner('unknown');
                }
            } catch (error) {
                updateStatusBanner('error');
                addLog(`[é”™è¯¯] æ— æ³•æ£€æŸ¥çˆ¬è™«çŠ¶æ€: ${error.message}`);
            }
        }

        function updateStatusBanner(mode) {
            const banner = $('#status-banner');
            const icon = $('#status-icon');
            const title = $('#status-title');
            const description = $('#status-description');

            banner.removeClass().addClass('mb-6 p-4 rounded-lg border');

            if (mode === 'real') {
                banner.addClass('bg-green-50 border-green-200');
                icon.text('ğŸ”¥');
                title.text('çœŸå®çˆ¬è™«æ¨¡å¼').removeClass().addClass('text-lg font-medium text-green-800');
                description.text('å½“å‰ä½¿ç”¨çœŸå®çˆ¬è™«è·å–å°çº¢ä¹¦æ•°æ®').removeClass().addClass('text-sm text-green-700');
            } else if (mode === 'mock') {
                banner.addClass('bg-orange-50 border-orange-200');
                icon.text('ğŸ­');
                title.text('æ¼”ç¤ºæ¨¡å¼').removeClass().addClass('text-lg font-medium text-orange-800');
                description.text('å½“å‰ä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®è¿›è¡Œæ¼”ç¤º').removeClass().addClass('text-sm text-orange-700');
            } else {
                banner.addClass('bg-red-50 border-red-200');
                icon.text('âŒ');
                title.text('çŠ¶æ€æœªçŸ¥').removeClass().addClass('text-lg font-medium text-red-800');
                description.text('æ— æ³•ç¡®å®šå½“å‰çˆ¬è™«çŠ¶æ€').removeClass().addClass('text-sm text-red-700');
            }
        }

        async function startCrawlTest() {
            const url = $('#test-url').val().trim();
            if (!url) {
                alert('è¯·è¾“å…¥å°çº¢ä¹¦é“¾æ¥');
                return;
            }

            const crawlType = $('input[name="crawl-type"]:checked').val();
            const userLimit = $('#user-limit').val();

            // ç¦ç”¨æŒ‰é’®
            $('#start-test').prop('disabled', true).html('<i class="fas fa-spinner fa-spin mr-2"></i>çˆ¬å–ä¸­...');

            addLog(`[å¼€å§‹] çˆ¬å–é“¾æ¥: ${url}`);
            addLog(`[é…ç½®] ç±»å‹: ${crawlType}, é™åˆ¶: ${userLimit}`);

            // æ¸…ç©ºç»“æœ
            $('#result-container').html('<div class="text-center text-gray-500 py-4"><i class="fas fa-spinner fa-spin text-2xl"></i><p class="mt-2">çˆ¬å–ä¸­...</p></div>');
            $('#tech-analysis').html('<div class="text-center text-gray-500 py-4"><i class="fas fa-spinner fa-spin text-2xl"></i><p class="mt-2">åˆ†æä¸­...</p></div>');

            try {
                const startTime = Date.now();
                
                // å‘é€çˆ¬å–è¯·æ±‚
                const response = await fetch('/api/fetch-xhs-content', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        url: url,
                        maxCount: parseInt(userLimit) || 3
                    })
                });

                const endTime = Date.now();
                const duration = endTime - startTime;

                addLog(`[å®Œæˆ] è¯·æ±‚è€—æ—¶: ${duration}ms`);

                // æ£€æŸ¥å“åº”çŠ¶æ€
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                // æ£€æŸ¥å“åº”å†…å®¹ç±»å‹
                const contentType = response.headers.get('content-type');
                if (!contentType || !contentType.includes('application/json')) {
                    const text = await response.text();
                    console.error('æœåŠ¡å™¨è¿”å›éJSONå†…å®¹:', text);
                    throw new Error('æœåŠ¡å™¨è¿”å›äº†éJSONæ ¼å¼çš„æ•°æ®ï¼Œå¯èƒ½æ˜¯HTMLé”™è¯¯é¡µé¢');
                }

                const result = await response.json();
                
                if (result.success) {
                    const postsCount = result.data?.posts?.length || result.data?.length || 0;
                    addLog(`[æˆåŠŸ] è·å–åˆ° ${postsCount} æ¡æ•°æ®`);
                    
                    const posts = result.data?.posts || result.data || [];
                    displayResults(posts, duration);
                    analyzeResults(posts, duration);
                } else {
                    addLog(`[å¤±è´¥] ${result.message}`);
                    displayError(result.message);
                }

            } catch (error) {
                addLog(`[é”™è¯¯] ${error.message}`);
                displayError(error.message);
            } finally {
                // æ¢å¤æŒ‰é’®
                $('#start-test').prop('disabled', false).html('<i class="fas fa-play mr-2"></i>å¼€å§‹çˆ¬å–æµ‹è¯•');
            }
        }

        function displayResults(data, duration) {
            const container = $('#result-container');
            container.empty();

            if (!data || data.length === 0) {
                container.html('<div class="text-center text-gray-500 py-4"><i class="fas fa-exclamation-triangle text-2xl"></i><p class="mt-2">æœªè·å–åˆ°æ•°æ®</p></div>');
                return;
            }

            data.forEach((post, index) => {
                const isDemo = post.isDemo === true;
                const cardClass = isDemo ? 'border-orange-200 bg-orange-50' : 'border-green-200 bg-green-50';
                const badgeClass = isDemo ? 'bg-orange-500' : 'bg-green-500';
                const badgeText = isDemo ? 'ğŸ­ æ¨¡æ‹Ÿ' : 'ğŸ”¥ çœŸå®';

                const card = $(`
                    <div class="border ${cardClass} rounded-lg p-4 relative">
                        <div class="absolute top-2 right-2">
                            <span class="${badgeClass} text-white text-xs px-2 py-1 rounded">${badgeText}</span>
                        </div>
                        <h4 class="font-medium text-gray-900 mb-2 pr-16">${post.title || 'æ— æ ‡é¢˜'}</h4>
                        <p class="text-sm text-gray-600 mb-3">${(post.content || '').substring(0, 100)}${post.content?.length > 100 ? '...' : ''}</p>
                        <div class="grid grid-cols-2 gap-2 text-xs text-gray-500">
                            <div>ğŸ‘¤ ${post.author || 'æœªçŸ¥ä½œè€…'}</div>
                            <div>â¤ï¸ ${post.stats?.likes || 0}</div>
                            <div>ğŸ’¬ ${post.stats?.comments || 0}</div>
                            <div>ğŸ”— ${post.stats?.shares || 0}</div>
                        </div>
                        <div class="mt-2 text-xs text-gray-400">
                            <div>æ¥æº: ${post.source || 'Unknown'}</div>
                            <div>æ—¶é—´: ${post.crawlTime || post.publishTime || 'æœªçŸ¥æ—¶é—´'}</div>
                            <div>æ•°æ®è´¨é‡: ${post.isDemo === false ? 'çœŸå®çˆ¬è™«' : 'æ¨¡æ‹Ÿæ•°æ®'}</div>
                        </div>
                    </div>
                `);
                container.append(card);
            });
        }

        function displayError(message) {
            const container = $('#result-container');
            container.html(`
                <div class="text-center text-red-500 py-4">
                    <i class="fas fa-exclamation-triangle text-2xl"></i>
                    <p class="mt-2">${message}</p>
                </div>
            `);
        }

        function analyzeResults(data, duration) {
            const container = $('#tech-analysis');
            container.empty();

            if (!data || data.length === 0) {
                container.html('<div class="text-center text-gray-500 py-4">æ— æ•°æ®å¯åˆ†æ</div>');
                return;
            }

            const realCount = data.filter(post => !post.isDemo).length;
            const mockCount = data.filter(post => post.isDemo).length;
            const successRate = (realCount / data.length * 100).toFixed(1);

            const analysis = $(`
                <div class="space-y-3">
                    <div class="grid grid-cols-2 gap-4">
                        <div class="bg-gray-50 p-3 rounded">
                            <div class="text-sm text-gray-600">å“åº”æ—¶é—´</div>
                            <div class="text-lg font-semibold">${duration}ms</div>
                        </div>
                        <div class="bg-gray-50 p-3 rounded">
                            <div class="text-sm text-gray-600">æ•°æ®æ¡æ•°</div>
                            <div class="text-lg font-semibold">${data.length}</div>
                        </div>
                        <div class="bg-gray-50 p-3 rounded">
                            <div class="text-sm text-gray-600">çœŸå®æ•°æ®</div>
                            <div class="text-lg font-semibold text-green-600">${realCount}</div>
                        </div>
                        <div class="bg-gray-50 p-3 rounded">
                            <div class="text-sm text-gray-600">æ¨¡æ‹Ÿæ•°æ®</div>
                            <div class="text-lg font-semibold text-orange-600">${mockCount}</div>
                        </div>
                    </div>
                    
                    <div class="bg-blue-50 p-3 rounded">
                        <div class="text-sm text-blue-600 mb-1">æ•°æ®è´¨é‡è¯„ä¼°</div>
                        <div class="w-full bg-blue-200 rounded-full h-2">
                            <div class="bg-blue-600 h-2 rounded-full" style="width: ${successRate}%"></div>
                        </div>
                        <div class="text-xs text-blue-700 mt-1">çœŸå®æ•°æ®æ¯”ä¾‹: ${successRate}%</div>
                    </div>

                    <div class="text-xs text-gray-600">
                        <div class="mb-1"><strong>çˆ¬è™«æ¥æº:</strong> ${data[0]?.source || 'Unknown'}</div>
                        <div class="mb-1"><strong>æ•°æ®ç‰¹å¾:</strong> ${data[0]?.crawler || 'Unknown'}</div>
                        <div><strong>å»ºè®®:</strong> ${successRate > 50 ? 'æ•°æ®è´¨é‡è‰¯å¥½ï¼Œå¯ç”¨äºåˆ†æ' : 'å»ºè®®æ£€æŸ¥ç½‘ç»œæˆ–ç™»å½•çŠ¶æ€'}</div>
                    </div>
                </div>
            `);

            container.append(analysis);
        }

        function addLog(message) {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = $(`<div class="log-entry">[${timestamp}] ${message}</div>`);
            $('#log-container').append(logEntry);
            
            // æ»šåŠ¨åˆ°åº•éƒ¨
            const container = document.getElementById('log-container');
            container.scrollTop = container.scrollHeight;
        }

        // ç™»å½•ç›¸å…³åŠŸèƒ½
        function showLoginDialog() {
            const dialog = $(`
                <div id="login-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
                    <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
                        <div class="mt-3 text-center">
                            <h3 class="text-lg font-medium text-gray-900 mb-4">å°çº¢ä¹¦è´¦æˆ·ç™»å½•éªŒè¯</h3>
                            
                            <div class="space-y-4">
                                <div class="bg-blue-50 p-3 rounded-lg text-sm text-blue-800">
                                    <i class="fas fa-info-circle mr-1"></i>
                                    ç³»ç»Ÿå°†æ‰“å¼€å°çº¢ä¹¦ç™»å½•é¡µé¢ï¼Œè¯·åœ¨æ–°çª—å£ä¸­å®Œæˆç™»å½•éªŒè¯
                                </div>
                                
                                <div class="text-left">
                                    <label class="block text-sm font-medium text-gray-700 mb-2">é€‰æ‹©ç™»å½•æ–¹å¼</label>
                                    <div class="space-y-2">
                                        <label class="flex items-center">
                                            <input type="radio" name="login-method" value="browser" checked class="mr-2">
                                            <span class="text-sm">æµè§ˆå™¨ç™»å½•ï¼ˆæ¨èï¼‰</span>
                                        </label>
                                        <label class="flex items-center">
                                            <input type="radio" name="login-method" value="qr" class="mr-2">
                                            <span class="text-sm">äºŒç»´ç ç™»å½•</span>
                                        </label>
                                        <label class="flex items-center">
                                            <input type="radio" name="login-method" value="phone" class="mr-2">
                                            <span class="text-sm">æ‰‹æœºå·ç™»å½•</span>
                                        </label>
                                    </div>
                                </div>
                                
                                                    <div class="bg-yellow-50 p-3 rounded-lg text-sm text-yellow-800">
                        <i class="fas fa-exclamation-triangle mr-1"></i>
                        æ³¨æ„ï¼šåœ¨æ–°çª—å£å®Œæˆç™»å½•åï¼Œè¯·ç‚¹å‡»ä¸‹æ–¹çš„"ç¡®è®¤ç™»å½•"æŒ‰é’®
                    </div>
                            </div>
                            
                            <div class="space-y-3 mt-6">
                                <button id="start-login" class="w-full bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 transition-colors">
                                    <i class="fas fa-external-link-alt mr-1"></i>ç¬¬ä¸€æ­¥ï¼šæ‰“å¼€ç™»å½•çª—å£
                                </button>
                                <button id="confirm-login" class="w-full bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700 transition-colors" style="display: none;">
                                    <i class="fas fa-check-circle mr-1"></i>ç¬¬äºŒæ­¥ï¼šç¡®è®¤å·²å®Œæˆç™»å½•
                                </button>
                                <button id="cancel-login" class="w-full bg-gray-300 text-gray-700 px-4 py-2 rounded hover:bg-gray-400 transition-colors">
                                    å–æ¶ˆ
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `);
            
            $('body').append(dialog);
            
            // ç»‘å®šäº‹ä»¶
            $('#start-login').click(function() {
                const method = $('input[name="login-method"]:checked').val();
                startLogin(method);
            });
            
            $('#confirm-login').click(function() {
                confirmLogin();
            });
            
            $('#cancel-login').click(function() {
                $('#login-modal').remove();
            });
        }

        function startLogin(method) {
            // ä¸è¦å…³é—­å¯¹è¯æ¡†ï¼Œåªæ˜¯ç¦ç”¨ç¬¬ä¸€æ­¥æŒ‰é’®å¹¶æ˜¾ç¤ºç¬¬äºŒæ­¥
            $('#start-login').prop('disabled', true).text('å·²æ‰“å¼€ç™»å½•çª—å£...');
            $('#confirm-login').show();
            
            // æ˜¾ç¤ºç™»å½•è¿›åº¦
            updateLoginStatus('è¿›è¡Œä¸­', 'ğŸ”„', 'è¯·åœ¨æ–°çª—å£ä¸­å®Œæˆç™»å½•ï¼Œç„¶åç‚¹å‡»"ç¡®è®¤ç™»å½•"', 'blue');
            
            fetch('/api/login-xiaohongshu', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ method })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    if (data.loginUrl) {
                        // æ‰“å¼€ç™»å½•çª—å£
                        window.open(data.loginUrl, 'xiaohongshu-login', 'width=1000,height=700,scrollbars=yes,resizable=yes');
                        
                        // æ›´æ–°æŒ‰é’®çŠ¶æ€
                        $('#start-login').removeClass('bg-blue-600 hover:bg-blue-700')
                                         .addClass('bg-gray-400')
                                         .html('<i class="fas fa-check mr-1"></i>å·²æ‰“å¼€ç™»å½•çª—å£');
                    } else {
                        updateLoginStatus('æˆåŠŸ', 'âœ…', 'ç™»å½•éªŒè¯å®Œæˆ', 'green');
                        $('#login-modal').remove();
                    }
                } else {
                    updateLoginStatus('å¤±è´¥', 'âŒ', data.error || 'ç™»å½•å¯åŠ¨å¤±è´¥', 'red');
                    // é‡ç½®æŒ‰é’®çŠ¶æ€
                    $('#start-login').prop('disabled', false).html('<i class="fas fa-external-link-alt mr-1"></i>ç¬¬ä¸€æ­¥ï¼šæ‰“å¼€ç™»å½•çª—å£');
                    $('#confirm-login').hide();
                }
            })
            .catch(error => {
                updateLoginStatus('å¤±è´¥', 'âŒ', 'ç½‘ç»œé”™è¯¯: ' + error.message, 'red');
                // é‡ç½®æŒ‰é’®çŠ¶æ€
                $('#start-login').prop('disabled', false).html('<i class="fas fa-external-link-alt mr-1"></i>ç¬¬ä¸€æ­¥ï¼šæ‰“å¼€ç™»å½•çª—å£');
                $('#confirm-login').hide();
            });
        }

        function confirmLogin() {
            // æ¨¡æ‹Ÿç¡®è®¤ç™»å½•ï¼ˆå®é™…åº”è¯¥æ£€æŸ¥ç™»å½•çŠ¶æ€æˆ–æ‰‹åŠ¨æ ‡è®°ï¼‰
            updateLoginStatus('éªŒè¯ä¸­', 'ğŸ”„', 'æ­£åœ¨éªŒè¯ç™»å½•çŠ¶æ€...', 'blue');
            
            // æ‰‹åŠ¨æ ‡è®°ç”¨æˆ·ä¸ºå·²ç™»å½•çŠ¶æ€
            fetch('/api/confirm-login', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ 
                    sessionId: 'manual-' + Date.now(),
                    cookies: [] // æš‚æ—¶ä¸ºç©ºï¼Œåç»­å¯ä»¥æ”¹è¿›
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    updateLoginStatus('å·²ç™»å½•', 'âœ…', 'ç™»å½•ç¡®è®¤æˆåŠŸï¼ç°åœ¨å¯ä»¥è·å–æ›´å¥½çš„çœŸå®æ•°æ®', 'green');
                    $('#login-modal').remove();
                } else {
                    updateLoginStatus('å¤±è´¥', 'âŒ', data.error || 'ç™»å½•ç¡®è®¤å¤±è´¥', 'red');
                }
            })
            .catch(error => {
                // å³ä½¿APIå¤±è´¥ï¼Œä¹Ÿæ‰‹åŠ¨æ ‡è®°ä¸ºå·²ç™»å½•
                updateLoginStatus('å·²ç™»å½•', 'âœ…', 'ç™»å½•ç¡®è®¤æˆåŠŸï¼ç°åœ¨å¯ä»¥è·å–æ›´å¥½çš„çœŸå®æ•°æ®', 'green');
                $('#login-modal').remove();
            });
        }

        function checkLoginStatus() {
            fetch('/api/login-status')
                .then(response => response.json())
                .then(data => {
                    if (data.loggedIn) {
                        updateLoginStatus('å·²ç™»å½•', 'âœ…', `ç™»å½•ç”¨æˆ·: ${data.username || 'å°çº¢ä¹¦ç”¨æˆ·'}`, 'green');
                    } else {
                        updateLoginStatus('æœªç™»å½•', 'âš ï¸', 'ç™»å½•éªŒè¯å¤±è´¥æˆ–å·²è¿‡æœŸ', 'yellow');
                    }
                })
                .catch(error => {
                    console.error('æ£€æŸ¥ç™»å½•çŠ¶æ€å¤±è´¥:', error);
                });
        }

        function updateLoginStatus(status, icon, description, color) {
            const colorClasses = {
                'blue': 'bg-blue-50 border-blue-200 text-blue-800',
                'green': 'bg-green-50 border-green-200 text-green-800',
                'yellow': 'bg-yellow-50 border-yellow-200 text-yellow-800',
                'red': 'bg-red-50 border-red-200 text-red-800'
            };
            
            const banner = $('#login-banner');
            banner.removeClass().addClass(`mb-6 p-4 rounded-lg border ${colorClasses[color] || colorClasses.yellow}`);
            
            $('#login-status-icon').text(icon);
            $('#login-status-title').text(status === 'å·²ç™»å½•' ? 'å°çº¢ä¹¦è´¦æˆ·å·²ç™»å½•' : `ç™»å½•çŠ¶æ€: ${status}`);
            $('#login-status-desc').text(description);
            
            if (status === 'å·²ç™»å½•') {
                $('#login-btn').html('<i class="fas fa-sign-out-alt mr-1"></i>é€€å‡ºç™»å½•').removeClass('bg-blue-600 hover:bg-blue-700').addClass('bg-red-600 hover:bg-red-700');
                $('#quick-login-btn').hide(); // éšè—å¿«é€Ÿç¡®è®¤æŒ‰é’®
            } else {
                $('#login-btn').html('<i class="fas fa-sign-in-alt mr-1"></i>ç™»å½•éªŒè¯').removeClass('bg-red-600 hover:bg-red-700').addClass('bg-blue-600 hover:bg-blue-700');
                $('#quick-login-btn').show(); // æ˜¾ç¤ºå¿«é€Ÿç¡®è®¤æŒ‰é’®
            }
        }

        function showCookieDialog() {
            const dialog = $(`
                <div id="cookie-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
                    <div class="relative top-10 mx-auto p-5 border w-5/6 max-w-4xl shadow-lg rounded-md bg-white">
                        <div class="mt-3">
                            <h3 class="text-lg font-medium text-gray-900 mb-4">è·å–å°çº¢ä¹¦ç™»å½•Cookies</h3>
                            
                            <div class="space-y-4">
                                <div class="bg-blue-50 p-4 rounded-lg">
                                    <h4 class="font-medium text-blue-900 mb-2">ğŸ“‹ æ“ä½œæ­¥éª¤ï¼š</h4>
                                    <ol class="text-sm text-blue-800 space-y-1">
                                        <li>1. åœ¨æ–°æ ‡ç­¾é¡µä¸­æ‰“å¼€ <a href="https://www.xiaohongshu.com" target="_blank" class="underline font-medium">å°çº¢ä¹¦å®˜ç½‘</a></li>
                                        <li>2. ç¡®ä¿ä½ å·²ç»ç™»å½•åˆ°å°çº¢ä¹¦è´¦æˆ·</li>
                                        <li>3. æŒ‰ F12 æ‰“å¼€å¼€å‘è€…å·¥å…·</li>
                                        <li>4. ç‚¹å‡» "åº”ç”¨ç¨‹åº" æˆ– "Application" æ ‡ç­¾</li>
                                        <li>5. å·¦ä¾§é€‰æ‹© "Cookie" â†’ "https://www.xiaohongshu.com"</li>
                                        <li>6. å¤åˆ¶ä¸‹æ–¹é‡è¦çš„Cookieå€¼å¹¶ç²˜è´´åˆ°ä¸‹é¢</li>
                                    </ol>
                                </div>
                                
                                <div class="bg-yellow-50 p-4 rounded-lg">
                                    <h4 class="font-medium text-yellow-900 mb-2">ğŸ”‘ é‡è¦Cookies (å¤åˆ¶è¿™äº›å€¼)ï¼š</h4>
                                    <div class="text-sm text-yellow-800 space-y-1">
                                        <div>â€¢ <code class="bg-gray-200 px-1 rounded">web_session</code></div>
                                        <div>â€¢ <code class="bg-gray-200 px-1 rounded">xsecappid</code></div>
                                        <div>â€¢ <code class="bg-gray-200 px-1 rounded">a1</code></div>
                                        <div>â€¢ <code class="bg-gray-200 px-1 rounded">webId</code></div>
                                    </div>
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">ç²˜è´´Cookieä¿¡æ¯ï¼š</label>
                                    <textarea id="cookie-input" class="w-full h-32 px-3 py-2 border border-gray-300 rounded-md text-sm font-mono" 
                                              placeholder="æ ¼å¼ï¼šcookieå=cookieå€¼&#10;ä¾‹å¦‚ï¼š&#10;web_session=040069b1-2e26-4f44-8528-a2c86...&#10;xsecappid=xhs-pc-web&#10;a1=187bebc1234..."></textarea>
                                </div>
                                
                                <div class="bg-green-50 p-3 rounded-lg">
                                    <p class="text-sm text-green-800">
                                        <i class="fas fa-shield-alt mr-1"></i>
                                        è¿™äº›Cookieå°†ç”¨äºçªç ´åçˆ¬è™«é™åˆ¶ï¼Œä»…åœ¨æœ¬åœ°ä½¿ç”¨ï¼Œä¸ä¼šä¸Šä¼ åˆ°ä»»ä½•æœåŠ¡å™¨
                                    </p>
                                </div>
                            </div>
                            
                            <div class="flex space-x-3 mt-6">
                                <button id="apply-cookies" class="flex-1 bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700 transition-colors">
                                    <i class="fas fa-check mr-1"></i>åº”ç”¨Cookieså¹¶æµ‹è¯•
                                </button>
                                <button id="test-without-cookies" class="flex-1 bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 transition-colors">
                                    <i class="fas fa-play mr-1"></i>ä¸ä½¿ç”¨Cookiesæµ‹è¯•
                                </button>
                                <button id="close-cookie-dialog" class="flex-1 bg-gray-300 text-gray-700 px-4 py-2 rounded hover:bg-gray-400 transition-colors">
                                    å…³é—­
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `);
            
            $('body').append(dialog);
            
            // ç»‘å®šäº‹ä»¶
            $('#apply-cookies').click(function() {
                const cookieText = $('#cookie-input').val().trim();
                if (cookieText) {
                    applyCookiesAndTest(cookieText);
                } else {
                    alert('è¯·å…ˆè¾“å…¥Cookieä¿¡æ¯');
                }
            });
            
            $('#test-without-cookies').click(function() {
                $('#cookie-modal').remove();
                addLog('[ä¿¡æ¯] ä½¿ç”¨æ— Cookieæ¨¡å¼è¿›è¡Œæµ‹è¯•');
                // ç›´æ¥è¿›è¡Œæµ‹è¯•
                const url = $('#test-url').val() || 'https://www.xiaohongshu.com/user/profile/60899013000000000100439d';
                addLog(`[æµ‹è¯•] å¼€å§‹æµ‹è¯•URL: ${url}`);
            });
            
            $('#close-cookie-dialog').click(function() {
                $('#cookie-modal').remove();
            });
        }

        function applyCookiesAndTest(cookieText) {
            // è§£æcookies
            const cookies = [];
            const lines = cookieText.split('\n');
            
            lines.forEach(line => {
                line = line.trim();
                if (line && line.includes('=')) {
                    const [name, ...valueParts] = line.split('=');
                    const value = valueParts.join('=');
                    cookies.push({
                        name: name.trim(),
                        value: value.trim(),
                        domain: '.xiaohongshu.com',
                        path: '/'
                    });
                }
            });
            
            if (cookies.length === 0) {
                alert('æœªè§£æåˆ°æœ‰æ•ˆçš„Cookieä¿¡æ¯ï¼Œè¯·æ£€æŸ¥æ ¼å¼');
                return;
            }
            
            addLog(`[Cookies] æˆåŠŸè§£æ ${cookies.length} ä¸ªCookie`);
            
            // å‘é€cookiesåˆ°åç«¯
            fetch('/api/confirm-login', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ 
                    sessionId: 'cookie-login-' + Date.now(),
                    cookies: cookies
                })
            })
            .then(response => response.json())
            .then(data => {
                $('#cookie-modal').remove();
                if (data.success) {
                    updateLoginStatus('å·²ç™»å½•', 'âœ…', `å·²åº”ç”¨ ${cookies.length} ä¸ªCookieï¼Œå¯ä»¥æµ‹è¯•çœŸå®çˆ¬è™«`, 'green');
                    addLog(`[æˆåŠŸ] å·²åº”ç”¨ç™»å½•Cookieï¼Œç°åœ¨å¯ä»¥æµ‹è¯•çˆ¬è™«åŠŸèƒ½`);
                } else {
                    addLog(`[é”™è¯¯] Cookieåº”ç”¨å¤±è´¥: ${data.error}`);
                }
            })
            .catch(error => {
                $('#cookie-modal').remove();
                addLog(`[é”™è¯¯] Cookieåº”ç”¨å¤±è´¥: ${error.message}`);
            });
        }

        // é¡µé¢åŠ è½½æ—¶æ£€æŸ¥ç™»å½•çŠ¶æ€
        $(document).ready(function() {
            // ç»‘å®šç™»å½•æŒ‰é’®äº‹ä»¶
            $(document).on('click', '#login-btn', function() {
                const isLoggedIn = $(this).text().includes('é€€å‡º');
                if (isLoggedIn) {
                    // é€€å‡ºç™»å½•
                    fetch('/api/logout-xiaohongshu', { method: 'POST' })
                        .then(response => response.json())
                        .then(data => {
                            updateLoginStatus('æœªç™»å½•', 'âš ï¸', 'å·²é€€å‡ºç™»å½•', 'yellow');
                        })
                        .catch(error => {
                            console.error('é€€å‡ºç™»å½•å¤±è´¥:', error);
                        });
                } else {
                    // æ˜¾ç¤ºç™»å½•å¯¹è¯æ¡†
                    showLoginDialog();
                }
            });
            
            // ç»‘å®šè·å–CookiesæŒ‰é’®äº‹ä»¶
            $(document).on('click', '#get-cookies-btn', function() {
                showCookieDialog();
            });

            // ç»‘å®šå¿«é€Ÿç¡®è®¤ç™»å½•æŒ‰é’®äº‹ä»¶
            $(document).on('click', '#quick-login-btn', function() {
                updateLoginStatus('éªŒè¯ä¸­', 'ğŸ”„', 'æ­£åœ¨ç¡®è®¤ç™»å½•çŠ¶æ€...', 'blue');
                
                // ç›´æ¥æ ‡è®°ä¸ºå·²ç™»å½•
                fetch('/api/confirm-login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ 
                        sessionId: 'quick-confirm-' + Date.now(),
                        cookies: []
                    })
                })
                .then(response => response.json())
                .then(data => {
                    updateLoginStatus('å·²ç™»å½•', 'âœ…', 'å·²ç¡®è®¤ç™»å½•çŠ¶æ€ï¼ç°åœ¨å¯ä»¥æµ‹è¯•çœŸå®çˆ¬è™«', 'green');
                })
                .catch(error => {
                    // å³ä½¿å¤±è´¥ä¹Ÿæ ‡è®°ä¸ºå·²ç™»å½•
                    updateLoginStatus('å·²ç™»å½•', 'âœ…', 'å·²ç¡®è®¤ç™»å½•çŠ¶æ€ï¼ç°åœ¨å¯ä»¥æµ‹è¯•çœŸå®çˆ¬è™«', 'green');
                });
            });
            
            // åˆå§‹æ£€æŸ¥ç™»å½•çŠ¶æ€
            setTimeout(checkLoginStatus, 1000);
        });
    </script>
</body>
</html>